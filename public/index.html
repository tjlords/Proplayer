<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Classplus DRM Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Plyr UI -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.6.2/plyr.css" />
  <script src="https://cdn.plyr.io/3.6.3/plyr.js"></script>

  <!-- dash.js for MPEG-DASH + Widevine -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/3.1.3/dash.all.min.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      background: #000;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Poppins",
        sans-serif;
    }
    #player {
      width: 100%;
      height: 100vh;
      background: #000;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <video id="player" controls playsinline></video>

  <script>
    (async () => {
      const qs = new URLSearchParams(window.location.search);
      const contentId = qs.get("contentId");
      const token = qs.get("token"); // optional, if not using env

      if (!contentId) {
        alert("Missing ?contentId= in URL");
        return;
      }

      // Same origin API (backend is this same app)
      let apiUrl = `/classplus/play?contentId=${encodeURIComponent(contentId)}`;
      if (token) {
        apiUrl += `&token=${encodeURIComponent(token)}`;
      }

      let data;
      try {
        const resp = await fetch(apiUrl);
        data = await resp.json();
      } catch (e) {
        console.error("Network error:", e);
        alert("Failed to contact backend /classplus/play");
        return;
      }

      if (!data || data.status !== "ok" || !data.drmUrls) {
        console.error("Bad response from backend:", data);
        alert("Backend did not return valid DRM URLs");
        return;
      }

      const mpd = data.drmUrls.manifestUrl;
      const licenseUrl = data.drmUrls.licenseUrl;

      console.log("MPD:", mpd);
      console.log("License URL:", licenseUrl);

      const video = document.getElementById("player");

      // Create dash.js player and configure Widevine
      const dashPlayer = dashjs.MediaPlayer().create();
      dashPlayer.initialize(video, mpd, false);

      dashPlayer.setProtectionData({
        "com.widevine.alpha": {
          serverURL: licenseUrl
          // If you ever need extra headers, dash.js supports request modifiers,
          // but usually Chrome's default headers are enough.
        }
      });

      // Optional: manual quality switching via Plyr
      dashPlayer.updateSettings({
        streaming: {
          abr: {
            autoSwitchBitrate: {
              video: false
            }
          }
        }
      });

      dashPlayer.on(
        dashjs.MediaPlayer.events.STREAM_INITIALIZED,
        function () {
          try {
            const levels = dashPlayer.getBitrateInfoListFor("video") || [];
            const heights = levels
              .map((l) => l.height)
              .filter(Boolean)
              .sort((a, b) => b - a);

            const plyrPlayer = new Plyr(video, {
              quality: {
                default: heights[0] || null,
                options: heights,
                forced: true,
                onChange: (value) => {
                  const idx = levels.findIndex((l) => l.height === value);
                  if (idx !== -1) {
                    dashPlayer.setQualityFor("video", idx);
                  }
                }
              }
            });

            console.log("Available qualities:", heights);
          } catch (e) {
            console.error("STREAM_INITIALIZED error:", e);
            new Plyr(video, {}); // basic controls anyway
          }
        }
      );
    })();
  </script>
</body>
</html>
